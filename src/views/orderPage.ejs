<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Checkout</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f4f7f9; margin: 0; padding: 20px; box-sizing: border-box; }
        .checkout-container { width: 100%; max-width: 450px; }
        .summary, .payment-form { padding: 30px; background: #fff; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .summary { margin-bottom: 20px; }
        h3 { margin-top: 0; color: #333; }
        ul { list-style: none; padding: 0; margin: 0 0 20px 0; }
        li { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
        li:last-child { border-bottom: none; }
        .total { font-weight: bold; font-size: 1.2em; display: flex; justify-content: space-between; padding-top: 15px; border-top: 2px solid #333; }
        #card-element { border: 1px solid #ccc; padding: 12px; border-radius: 4px; margin-bottom: 20px; }
        button { width: 100%; padding: 14px; background-color: #6772e5; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #5469d4; }
        button:disabled { background-color: #a9b3f9; cursor: not-allowed; }
        #payment-message { margin-top: 15px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>
    <div class="checkout-container">
        <div class="summary">
            <h3>Order Summary</h3>
            <ul>
                <% cartItems.forEach(item => { %>
                    <li>
                        <span><%= item.name %></span>
                        <span>$<%= item.price %></span>
                    </li>
                <% }) %>
            </ul>
            <div class="total">
                <span>Total</span>
                <span>$<%= totalAmountForDisplay %></span>
            </div>
        </div>

        <div class="payment-form">
            <h3>Pay with Card</h3>
            <div id="card-element"></div>
            <button id="submit-button">Pay $<%= totalAmountForDisplay %></button>
            <div id="payment-message"></div>
        </div>
    </div>

    <script>
        const stripe = Stripe('<%= stripePublishableKey %>');
        const cardElement = stripe.elements().create('card');
        cardElement.mount('#card-element');

        const submitButton = document.getElementById('submit-button');
        const messageDiv = document.getElementById('payment-message');
        // const totalAmountInCents = <%= totalAmountInCents %>;

        submitButton.addEventListener('click', async () => {
            submitButton.disabled = true;
            messageDiv.textContent = 'Processing...';

            // Use the /order/create-payment-intent route now
            const response = await fetch('/product/create-payment-intent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            });

            if (!response.ok) {
                messageDiv.textContent = 'Error: Could not start payment.';
                submitButton.disabled = false;
                return;
            }

            const { clientSecret } = await response.json();

            const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                payment_method: { card: cardElement },
            });

            if (error) {
                messageDiv.textContent = `Error: ${error.message}`;
                submitButton.disabled = false;
            } else if (paymentIntent.status === 'succeeded') {
                messageDiv.textContent = 'âœ… Payment Successful!';
                // Button remains disabled after success
            }
        });
    </script>
</body>
</html>
